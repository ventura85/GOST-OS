name: Build GOST OS ISO

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'auto/**'
      - 'config/**'
      - '.github/workflows/build-iso.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm-slim
      options: --privileged
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            live-build debootstrap xorriso syslinux isolinux \
            squashfs-tools dosfstools ca-certificates locales \
            gnupg dirmngr curl git
      - name: Configure live-build
        run: |
          lb config noauto \
            --mode debian \
            --architectures amd64 \
            --distribution bookworm \
            --binary-images iso-hybrid \
            --debian-installer false \
            --archive-areas "main contrib non-free non-free-firmware" \
            --firmware-binary true \
            --firmware-chroot true
      - name: Build ISO
        run: |
          # Uruchamiamy live-build w minimalnym środowisku,
          # żeby uniknąć przekazywania setek zmiennych środowiskowych
          env -i HOME="$HOME" PATH="/usr/sbin:/usr/bin:/bin:/sbin" \
            lb build --force 2>&1 | tee build.log
      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: gostos-bookworm-amd64.iso
          path: live-image-amd64.hybrid.iso
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: live-build-logs
          path: build.log
