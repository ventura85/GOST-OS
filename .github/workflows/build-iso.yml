name: Build GOST OS ISO (Prebuilt Theme)

on:
  push:
    branches: [ "main", "finalna-konfiguracja" ]
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest

    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: 🧰 Prepare environment
        run: |
          sudo apt-get update
          sudo apt-get install -y live-build debootstrap systemd-container xorriso

      - name: 🧱 Verify prebuilt .deb exists
        run: |
          if [ ! -f config/packages.chroot/gost-theme_1.0_all.deb ]; then
            echo "❌ Missing gost-theme_1.0_all.deb! Add it to config/packages.chroot/"
            exit 1
          fi
          echo "✅ Found gost-theme_1.0_all.deb"

      - name: 🐳 Build Debian Live ISO in Docker
        run: |
          docker run --rm --privileged \
            -v "${{ github.workspace }}":/build \
            -w /build \
            debian:trixie-slim \
            sh -c "
              apt-get update &&
              apt-get install -y live-build systemd-sysv &&
              chmod +x auto/config &&
              ./auto/config &&
              lb build
            "

      - name: 📦 Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: GOSTOS-debian-trixie-live.iso
          path: live-image-amd64.hybrid.iso
